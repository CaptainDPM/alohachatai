<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade Your Plan | AlohaChatAI</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="styles.css">
    <!-- Stripe.js for checkout -->
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">AlohaChatAI</div>
                <div class="nav-links">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="upgrade.html" class="active">Upgrade</a>
                    <a href="#" id="logout-btn">Logout</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="pricing-section">
            <div class="section-header">
                <h1>Choose Your Plan</h1>
                <p>Select the perfect plan for your business needs</p>
            </div>

            <div class="plan-toggle">
                <span>Monthly</span>
                <label class="switch">
                    <input type="checkbox" id="billing-toggle">
                    <span class="slider"></span>
                </label>
                <span>Annual (Save 20%)</span>
            </div>

            <div class="plans-grid">
                <!-- Starter Plan -->
                <div class="plan-card">
                    <div class="plan-header">
                        <h3>Starter</h3>
                        <div class="price">
                            <span class="monthly-price">$49.99</span>
                            <span class="annual-price" style="display:none">$39.99</span>
                            <span>/mo</span>
                        </div>
                        <p class="billed-text monthly-text">Billed monthly</p>
                        <p class="billed-text annual-text" style="display:none">Billed annually ($479.88)</p>
                    </div>
                    <ul class="plan-features">
                        <li>✓ 250 conversations/month</li>
                        <li>✓ Basic knowledge base</li>
                        <li>✓ Email support</li>
                        <li>✓ Standard branding</li>
                        <li>✓ Basic analytics</li>
                    </ul>
                    <button class="btn btn-secondary plan-select" data-plan="starter-monthly">Select Plan</button>
                </div>

                <!-- Professional Plan (Popular) -->
                <div class="plan-card popular">
                    <div class="popular-badge">Most Popular</div>
                    <div class="plan-header">
                        <h3>Professional</h3>
                        <div class="price">
                            <span class="monthly-price">$149.99</span>
                            <span class="annual-price" style="display:none">$119.99</span>
                            <span>/mo</span>
                        </div>
                        <p class="billed-text monthly-text">Billed monthly</p>
                        <p class="billed-text annual-text" style="display:none">Billed annually ($1,439.88)</p>
                    </div>
                    <ul class="plan-features">
                        <li>✓ 2,000 conversations/month</li>
                        <li>✓ Advanced knowledge base</li>
                        <li>✓ Priority email support</li>
                        <li>✓ Full white-labeling</li>
                        <li>✓ Booking integration</li>
                        <li>✓ Advanced analytics</li>
                    </ul>
                    <button class="btn btn-primary plan-select" data-plan="professional-monthly">Select Plan</button>
                </div>

                <!-- Unlimited Plan -->
                <div class="plan-card">
                    <div class="plan-header">
                        <h3>Unlimited</h3>
                        <div class="price">
                            <span class="monthly-price">$199.99</span>
                            <span class="annual-price" style="display:none">$159.99</span>
                            <span>/mo</span>
                        </div>
                        <p class="billed-text monthly-text">Billed monthly</p>
                        <p class="billed-text annual-text" style="display:none">Billed annually ($1,919.88)</p>
                    </div>
                    <ul class="plan-features">
                        <li>✓ Unlimited conversations</li>
                        <li>✓ Custom AI training</li>
                        <li>✓ 24/7 dedicated support</li>
                        <li>✓ API access</li>
                        <li>✓ Multi-location support</li>
                        <li>✓ Custom integrations</li>
                    </ul>
                    <button class="btn btn-secondary plan-select" data-plan="unlimited-monthly">Select Plan</button>
                </div>
            </div>

            <div class="plan-comparison">
                <h2>Plan Comparison</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Starter</th>
                            <th>Professional</th>
                            <th>Unlimited</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Monthly Conversations</td>
                            <td>250</td>
                            <td>2,000</td>
                            <td>Unlimited</td>
                        </tr>
                        <tr>
                            <td>Knowledge Base</td>
                            <td>Basic</td>
                            <td>Advanced</td>
                            <td>Custom</td>
                        </tr>
                        <tr>
                            <td>Support</td>
                            <td>Email</td>
                            <td>Priority Email</td>
                            <td>24/7 Dedicated</td>
                        </tr>
                        <tr>
                            <td>Branding</td>
                            <td>Standard</td>
                            <td>White-label</td>
                            <td>White-label</td>
                        </tr>
                        <tr>
                            <td>Integrations</td>
                            <td>-</td>
                            <td>Booking</td>
                            <td>Custom</td>
                        </tr>
                        <tr>
                            <td>Analytics</td>
                            <td>Basic</td>
                            <td>Advanced</td>
                            <td>Advanced</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Checkout Modal (hidden by default) -->
        <div id="checkout-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Complete Your Purchase</h2>
                <div id="checkout-details">
                    <p>You're subscribing to: <strong id="selected-plan-name">Professional Plan</strong></p>
                    <p>Billing: <strong id="selected-billing-cycle">Monthly</strong></p>
                    <p>Total: <strong id="selected-plan-price">$149.99/mo</strong></p>
                </div>
                <div id="payment-form">
                    <!-- Stripe Elements will be inserted here -->
                    <div id="card-element"></div>
                    <div id="card-errors" role="alert"></div>
                    <button id="submit-payment" class="btn btn-primary">Subscribe Now</button>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDj8RVucd-TZBVQt080g_nk1MKU6knGZ8o",
            authDomain: "chatbot-8cc09.firebaseapp.com",
            projectId: "chatbot-8cc09",
            storageBucket: "chatbot-8cc09.firebasestorage.app",
            messagingSenderId: "362283614085",
            appId: "1:362283614085:web:146160adf6b5d2b198ceec",
            measurementId: "G-MWYVYVSGHE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Stripe setup (replace with your publishable key)
        const stripe = Stripe('pk_test_your_publishable_key_here');
        let elements;
        let cardElement;

        // Plan data
        const plans = {
            'starter-monthly': { name: 'Starter', price: 4999, interval: 'month', messages: 250 },
            'starter-annual': { name: 'Starter', price: 3999, interval: 'year', messages: 250 },
            'professional-monthly': { name: 'Professional', price: 14999, interval: 'month', messages: 2000 },
            'professional-annual': { name: 'Professional', price: 11999, interval: 'year', messages: 2000 },
            'unlimited-monthly': { name: 'Unlimited', price: 19999, interval: 'month', messages: -1 }, // -1 for unlimited
            'unlimited-annual': { name: 'Unlimited', price: 15999, interval: 'year', messages: -1 }
        };

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function () {
            // Billing toggle
            const billingToggle = document.getElementById('billing-toggle');
            billingToggle.addEventListener('change', toggleBilling);

            // Plan selection buttons
            document.querySelectorAll('.plan-select').forEach(button => {
                button.addEventListener('click', handlePlanSelect);
            });

            // Modal close button
            document.querySelector('.close-modal').addEventListener('click', closeModal);

            // Initialize Stripe Elements
            initStripe();

            // Check auth state
            auth.onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'signup-login.html';
                }
            });
        });

        function toggleBilling() {
            const isAnnual = billingToggle.checked;

            // Toggle price display
            document.querySelectorAll('.monthly-price').forEach(el => {
                el.style.display = isAnnual ? 'none' : 'inline';
            });
            document.querySelectorAll('.annual-price').forEach(el => {
                el.style.display = isAnnual ? 'inline' : 'none';
            });

            // Toggle billing text
            document.querySelectorAll('.monthly-text').forEach(el => {
                el.style.display = isAnnual ? 'none' : 'block';
            });
            document.querySelectorAll('.annual-text').forEach(el => {
                el.style.display = isAnnual ? 'block' : 'none';
            });

            // Update plan buttons data attributes
            document.querySelectorAll('.plan-select').forEach(button => {
                const plan = button.dataset.plan;
                const newPlan = isAnnual ? plan.replace('monthly', 'annual') : plan.replace('annual', 'monthly');
                button.dataset.plan = newPlan;
            });
        }

        function handlePlanSelect(e) {
            const planId = e.target.dataset.plan;
            const plan = plans[planId];
            const isAnnual = planId.includes('annual');

            // Update modal display
            document.getElementById('selected-plan-name').textContent = plan.name;
            document.getElementById('selected-billing-cycle').textContent = isAnnual ? 'Annual' : 'Monthly';
            document.getElementById('selected-plan-price').textContent =
                `$${(plan.price / 100).toFixed(2)}/${isAnnual ? 'year' : 'mo'}`;

            // Show modal
            document.getElementById('checkout-modal').style.display = 'block';

            // Store selected plan
            currentPlan = planId;
        }

        function closeModal() {
            document.getElementById('checkout-modal').style.display = 'none';
        }

        function initStripe() {
            elements = stripe.elements();
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                        fontFamily: '"Poppins", sans-serif'
                    }
                }
            });
            cardElement.mount('#card-element');

            // Handle real-time validation errors
            cardElement.on('change', function (event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });

            // Handle form submission
            document.getElementById('submit-payment').addEventListener('click', handlePayment);
        }

        async function handlePayment() {
            const submitButton = document.getElementById('submit-payment');
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            try {
                // Create payment intent on your server
                const response = await fetch('https://your-server.com/create-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await auth.currentUser.getIdToken()}`
                    },
                    body: JSON.stringify({
                        plan: currentPlan,
                        userId: auth.currentUser.uid
                    })
                });

                const { clientSecret } = await response.json();

                // Confirm payment with Stripe
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement
                    }
                });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    submitButton.disabled = false;
                    submitButton.textContent = 'Subscribe Now';
                } else {
                    // Payment successful - update Firestore
                    await db.collection('businesses').doc(auth.currentUser.uid).update({
                        plan: currentPlan.split('-')[0], // e.g. 'professional'
                        messagesLeft: plans[currentPlan].messages,
                        billingCycle: plans[currentPlan].interval,
                        lastPayment: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Show success message
                    alert('Payment successful! Your plan has been updated.');
                    closeModal();
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('card-errors').textContent = 'An error occurred. Please try again.';
                submitButton.disabled = false;
                submitButton.textContent = 'Subscribe Now';
            }
        }
    </script>
</body>

</html>