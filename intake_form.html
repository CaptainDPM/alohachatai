<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">


  <script src="https://unpkg.com/cloudinary-core@2.11.4/cloudinary-core-shrinkwrap.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --border: #e9ecef;
      --success: #4bb543;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7ff;
      color: var(--dark);
      line-height: 1.6;
      padding: 2rem;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 2.5rem;
    }

    h1 {
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-weight: 600;
      font-size: 2rem;
    }

    h3 {
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
      color: var(--dark);
    }

    .section {
      margin-bottom: 1.75rem;
      padding-bottom: 1.75rem;
      border-bottom: 1px solid var(--border);
    }

    .section:last-child {
      border-bottom: none;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      margin-bottom: 1rem;
      transition: border 0.2s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.875rem 1.75rem;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    button:hover {
      background-color: var(--primary-light);
    }

    #status {
      margin-top: 1rem;
      font-size: 0.9rem;
      padding: 0.75rem;
      border-radius: 8px;
      background-color: rgba(75, 181, 67, 0.1);
      color: var(--success);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    #status::before {
      content: "✓";
      font-weight: bold;
    }

    .test-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px dashed var(--border);
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
    }

    .input-group input {
      flex: 1;
      margin-bottom: 0;
    }

    .test-result {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }

    .logo-upload {
      margin-bottom: 1.5rem;
    }

    .logo-preview {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      object-fit: contain;
      border: 1px dashed var(--border);
      margin-top: 1rem;
      display: none;
    }

    .upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 1rem;
    }

    .upload-area:hover {
      border-color: var(--primary-light);
      background: rgba(67, 97, 238, 0.05);
    }

    .upload-area.has-image {
      border: none;
      padding: 0;
      background: transparent;
    }

    .upload-instructions {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .upload-icon {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }

      .container {
        padding: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Chatbot Configuration</h1>

    <div class="section">
      <h3>Business Information</h3>
      <div class="logo-upload">
        <h4>Business Logo</h4>
        <div id="uploadArea" class="upload-area">
          <div id="uploadContent">
            <div class="upload-icon">⬆️</div>
            <p>Click to upload logo<br>
              <span class="upload-instructions">(PNG/JPG, max 2MB)</span>
            </p>
          </div>
          <img id="logoPreview" class="logo-preview" alt="Logo preview">
        </div>
        <input type="file" id="logoInput" accept="image/*" style="display: none;">
      </div>
      <input id="businessName" placeholder="e.g. Aloha Dental">
      <input id="websiteUrl" placeholder="https://yourclinic.com">
    </div>

    <div class="section">
      <h3>Booking System</h3>
      <select id="bookingType">
        <option value="none">No booking system</option>
        <option value="booker">Booker</option>
        <option value="dentrix">Dentrix</option>
      </select>
      <input id="bookingUrl" placeholder="Booking page URL" style="display: none;">
    </div>

    <div class="section">
      <h3>Frequently Asked Questions</h3>
      <p style="margin-bottom: 0.75rem; font-size: 0.9rem; color: #6c757d;">
        Add common questions and answers (one per line):
      </p>
      <textarea id="faqs" placeholder="Q: What's your cancellation policy?
A: 24 hours notice required..."></textarea>
    </div>

    <button onclick="saveConfig()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
      Save Configuration
    </button>
    <div id="status"></div>

    <div class="test-section" id="testSection" style="display: none;">
      <h3>Test Your Chatbot</h3>
      <div class="input-group">
        <input id="testQuestion" placeholder="Ask something...">
        <button onclick="testChatbot()">Ask</button>
      </div>
      <div class="test-result" id="testResult"></div>
    </div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDj8RVucd-TZBVQt080g_nk1MKU6knGZ8o",
      authDomain: "chatbot-8cc09.firebaseapp.com",
      projectId: "chatbot-8cc09",
      storageBucket: "chatbot-8cc09.appspot.com",
      messagingSenderId: "362283614085",
      appId: "1:362283614085:web:146160adf6b5d2b198ceec"
    };

    // Initialize Firebase only if it hasn't been initialized already
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Initialize Cloudinary
    const cloudinary = cloudinary.Cloudinary.new({
      cloud_name: "dkxaipttt"
    });

    // Test Firestore connection
    db.collection("test").doc("connection").set({ test: true })
      .then(() => console.log("Firestore connection successful!"))
      .catch(err => console.error("Firestore error:", err));

    // Toggle booking URL field
    document.getElementById('bookingType').addEventListener('change', (e) => {
      document.getElementById('bookingUrl').style.display =
        e.target.value === 'none' ? 'none' : 'block';
    });

    const logoInput = document.getElementById('logoInput');
    const logoPreview = document.getElementById('logoPreview');
    const uploadArea = document.getElementById('uploadArea');
    const uploadContent = document.getElementById('uploadContent');

    // Click handler for upload area
    uploadArea.addEventListener('click', () => logoInput.click());

    // Preview uploaded logo
    logoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 2 * 1024 * 1024) {
        alert('File too large (max 2MB)');
        return;
      }

      const reader = new FileReader();
      reader.onload = (event) => {
        logoPreview.src = event.target.result;
        logoPreview.style.display = 'block';
        uploadContent.style.display = 'none';
        uploadArea.classList.add('has-image');
      };
      reader.readAsDataURL(file);
    });

    async function saveConfig() {
      const logoFile = document.getElementById('logoInput').files[0];
      let logoUrl = document.getElementById('logoPreview').src || null;

      // Upload logo to Cloudinary if new file was selected
      if (logoFile) {
        const formData = new FormData();
        formData.append('file', logoFile);
        formData.append('upload_preset', 'Chatbot Preset');

        try {
          const response = await fetch(
            `https://api.cloudinary.com/v1_1/dkxaipttt/image/upload`,
            { method: 'POST', body: formData }
          );
          const data = await response.json();
          logoUrl = cloudinary.url(data.public_id, {
            width: 200,
            crop: 'scale',
            secure: true
          });
          console.log("Cloudinary upload successful:", logoUrl);
        } catch (err) {
          console.error("Cloudinary upload failed:", err);
          alert("Logo upload failed. Please try again.");
          return;
        }
      }

      // Save config to Firestore
      const config = {
        name: document.getElementById('businessName').value,
        websiteUrl: document.getElementById('websiteUrl').value,
        booking: {
          type: document.getElementById('bookingType').value,
          url: document.getElementById('bookingUrl').value
        },
        faqs: document.getElementById('faqs').value.split('\n'),
        logoUrl
      };

      try {
        await db.collection('business_configs').doc(config.name).set(config);

        // Cache locally for performance
        localStorage.setItem('chatbotConfig', JSON.stringify({
          ...config,
          lastUpdated: Date.now()
        }));

        document.getElementById('status').textContent = "Configuration saved successfully!";
        document.getElementById('testSection').style.display = 'block';
        console.log("Configuration saved to Firestore");
      } catch (err) {
        console.error("Firestore save error:", err);
        alert("Failed to save configuration. Please check console for details.");
      }
    }

    // Load saved config on page load
    window.addEventListener('DOMContentLoaded', () => {
      const savedConfig = localStorage.getItem('chatbotConfig');
      window.cloudinary = cloudinary;
      if (savedConfig) {
        const config = JSON.parse(savedConfig);
        if (config.logoUrl) {
          logoPreview.src = config.logoUrl;
          logoPreview.style.display = 'block';
          uploadContent.style.display = 'none';
          uploadArea.classList.add('has-image');
        }
        if (config.name) document.getElementById('businessName').value = config.name;
        if (config.websiteUrl) document.getElementById('websiteUrl').value = config.websiteUrl;
        if (config.booking) {
          document.getElementById('bookingType').value = config.booking.type || 'none';
          document.getElementById('bookingUrl').value = config.booking.url || '';
          document.getElementById('bookingUrl').style.display =
            (config.booking.type && config.booking.type !== 'none') ? 'block' : 'none';
        }
        if (config.faqs) document.getElementById('faqs').value = config.faqs.join('\n');
      }
    });

    // Test chatbot (mock function)
    function testChatbot() {
      const question = document.getElementById('testQuestion').value;
      const config = JSON.parse(localStorage.getItem('chatbotConfig')) || {};

      // Mock response - replace with real API call
      let answer = "This is a simulated response. ";
      answer += `Your business '${config.name}' would respond to "${question}" `;
      answer += `using data from ${config.websiteUrl}.`;

      document.getElementById('testResult').innerHTML = `
        <strong>Question:</strong> ${question}<br><br>
        <strong>Response:</strong> ${answer}
      `;
    }
  </script>
</body>

</html>