<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful | AlohaChatAI</title>
    <link rel="icon" href="assets/logo.png" type="image/x-icon">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">AlohaChatAI</div>
                <div class="nav-links">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="upgrade.html">Upgrade</a>
                    <a href="#" id="logout-btn">Logout</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="success-section">
            <div class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h1>Payment Successful!</h1>
                <p>Thank you for upgrading your AlohaChatAI plan.</p>
                <p>Your subscription is now active and you can start using all the premium features immediately.</p>
                <div class="order-details">
                    <h3>Order Details</h3>
                    <div id="order-info">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                <a href="dashboard.html" class="btn btn-primary">Go to Dashboard</a>
            </div>
        </section>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Firebase config (same as your other pages)
        const firebaseConfig = {
            apiKey: "AIzaSyDj8RVucd-TZBVQt080g_nk1MKU6knGZ8o",
            authDomain: "chatbot-8cc09.firebaseapp.com",
            projectId: "chatbot-8cc09",
            storageBucket: "chatbot-8cc09.firebasestorage.app",
            messagingSenderId: "362283614085",
            appId: "1:362283614085:web:146160adf6b5d2b198ceec",
            measurementId: "G-MWYVYVSGHE",
        };

        const plans = {
            "starter-monthly": {
                name: "Starter",
                price: 4999,
                interval: "month",
                messages: 250,
            },
            "starter-annual": {
                name: "Starter",
                price: 47988,
                interval: "year",
                messages: 250,
            },
            "professional-monthly": {
                name: "Professional",
                price: 14999,
                interval: "month",
                messages: 2000,
            },
            "professional-annual": {
                name: "Professional",
                price: 143988,
                interval: "year",
                messages: 2000,
            },
            "unlimited-monthly": {
                name: "Unlimited",
                price: 19999,
                interval: "month",
                messages: -1,
            }, // -1 for unlimited
            "unlimited-annual": {
                name: "Unlimited",
                price: 191988,
                interval: "year",
                messages: -1,
            },
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', async function () {
            // Check auth state
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = "signup-login.html";
                    return;
                }
            });

            // Get the session ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');

            if (sessionId) {
                try {
                    const planId = localStorage.getItem('selectedPlan');
                    if (planId) {
                        await db.collection("businesses").doc(user.uid).update({
                            plan: planId.split("-")[0],
                            messagesLeft: plans[planId].messages,
                            billingCycle: plans[planId].interval,
                            lastPayment: firebase.firestore.FieldValue.serverTimestamp(),
                            status: "active"
                        });
                        localStorage.removeItem('selectedPlan');
                    }
                    // Fetch the session details from your backend
                    const response = await fetch('https://yhanf5calz7wg433mk63v7tn340sfkuu.lambda-url.us-east-1.on.aws/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action: 'retrieve_session', sessionId })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to retrieve session details');
                    }

                    const session = await response.json();
                    displayOrderDetails(session);
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('order-info').innerHTML = `
            <p>We've received your payment, but couldn't retrieve order details.</p>
            <p>Your account has been upgraded successfully.</p>
          `;
                }
            }
        });

        function displayOrderDetails(session) {
            const orderInfo = document.getElementById('order-info');
            const planName = session.display_items[0].plan.nickname || 'Premium Plan';
            const amount = (session.amount_total / 100).toFixed(2);
            const currency = session.currency.toUpperCase();

            orderInfo.innerHTML = `
        <p><strong>Plan:</strong> ${planName}</p>
        <p><strong>Amount:</strong> ${currency} ${amount}</p>
        <p><strong>Status:</strong> Paid</p>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
      `;
        }
    </script>
</body>

</html>