<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Dashboard | AlohaChatAI</title>
  <link rel="icon" href="assets/logo.png" type="image/x-icon" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header>
    <div class="container">
      <nav>
        <div class="logo">
          <i class="fas fa-robot"></i>
          AlohaChatAI
        </div>
        <div class="nav-links">
          <a href="dashboard.html">Dashboard</a>
          <a href="upgrade.html">Upgrade</a>
          <a href="#" id="logout-btn">Logout</a>
        </div>
      </nav>
    </div>
  </header>

  <main class="container dashboard">
    <div class="dashboard-header">
      <div class="dashboard-title">
        <h1>Welcome back, <span id="business-name">Loading...</span></h1>
        <p>Here's what's happening with your account today</p>
      </div>
      <div class="btn-group">
        <button id="upgrade-btn" class="btn btn-primary">Upgrade Plan</button>
        <button id="buy-msgs-btn" class="btn btn-secondary">
          Buy Messages
        </button>
      </div>
    </div>

    <div class="alert alert-warning" id="low-message-alert" style="display: none">
      <div class="alert-icon">⚠️</div>
      <div class="alert-content">
        <h4>Low message balance</h4>
        <p>
          You're running low on messages. Consider upgrading your plan or
          purchasing additional messages.
        </p>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-header">
          <span class="stat-card-title">Messages Used</span>
          <div class="stat-card-icon">💬</div>
        </div>
        <div class="stat-card-value" id="messages-used">0</div>
        <p class="stat-card-desc">Total messages sent this month</p>
      </div>

      <div class="stat-card">
        <div class="stat-card-header">
          <span class="stat-card-title">Messages Remaining</span>
          <div class="stat-card-icon">🔢</div>
        </div>
        <div class="stat-card-value" id="message-count">0</div>
        <p class="stat-card-desc">Available in your current plan</p>
      </div>

      <div class="stat-card">
        <div class="stat-card-header">
          <span class="stat-card-title">Current Plan</span>
          <div class="stat-card-icon">📊</div>
        </div>
        <div class="stat-card-value" id="current-plan">None</div>
        <p class="stat-card-desc" id="plan-details">No active subscription</p>
      </div>
    </div>

    <div class="usage-card">
      <div class="usage-card-header">
        <h2 class="usage-card-title">Message Usage</h2>
        <span class="stat-card-desc">Monthly cycle resets on <span id="billing-cycle">1st</span></span>
      </div>
      <div class="usage-bar">
        <div class="usage-bar-fill" id="usage-bar" style="width: 0%"></div>
      </div>
      <div class="usage-details">
        <div class="usage-detail">
          <span class="usage-detail-label">Used</span>
          <span class="usage-detail-value" id="used-value">0</span>
        </div>
        <div class="usage-detail">
          <span class="usage-detail-label">Remaining</span>
          <span class="usage-detail-value" id="remaining-value">0</span>
        </div>
        <div class="usage-detail">
          <span class="usage-detail-label">Total</span>
          <span class="usage-detail-value" id="total-value">0</span>
        </div>
      </div>
    </div>

    <div class="card-grid">
      <div class="quick-action-card">
        <h3>Get More Messages</h3>
        <p>
          Purchase additional message packs to keep your business running
          smoothly.
        </p>
        <button class="btn btn-primary" id="buy-msgs-btn-2">
          Buy Messages
        </button>
      </div>
      <div class="quick-action-card">
        <h3>Upgrade Your Plan</h3>
        <p>
          Unlock higher message limits and additional features with our
          premium plans.
        </p>
        <button class="btn btn-primary" id="upgrade-btn-2">View Plans</button>
      </div>
      <div class="quick-action-card">
        <h3>Account Settings</h3>
        <p>
          Update your business information, billing details, and preferences.
        </p>
        <button class="btn btn-secondary" id="settings-btn">Settings</button>
      </div>
    </div>

    <div class="recent-activity">
      <div class="recent-activity-header">
        <h2 class="recent-activity-title">Recent Activity</h2>
        <button class="btn btn-secondary">View All</button>
      </div>
      <ul class="activity-list" id="activity-list">
        <li class="activity-item">
          <div class="activity-icon">📊</div>
          <div class="activity-content">
            <p class="activity-message">Your monthly usage report is ready</p>
            <span class="activity-time">Just now</span>
          </div>
        </li>
        <li class="activity-item">
          <div class="activity-icon">💬</div>
          <div class="activity-content">
            <p class="activity-message">Sent 15 messages to customers</p>
            <span class="activity-time">2 hours ago</span>
          </div>
        </li>
        <li class="activity-item">
          <div class="activity-icon">🔄</div>
          <div class="activity-content">
            <p class="activity-message">Plan updated to Business Tier</p>
            <span class="activity-time">Yesterday</span>
          </div>
        </li>
      </ul>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <script>
    function goTo(page) {
      window.location.href = `${location.origin}${location.pathname.replace(
        /[^/]*$/,
        ""
      )}${page}`;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDj8RVucd-TZBVQt080g_nk1MKU6knGZ8o",
      authDomain: "chatbot-8cc09.firebaseapp.com",
      projectId: "chatbot-8cc09",
      storageBucket: "chatbot-8cc09.firebasestorage.app",
      messagingSenderId: "362283614085",
      appId: "1:362283614085:web:146160adf6b5d2b198ceec",
      measurementId: "G-MWYVYVSGHE",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Sample plan details (you would replace this with your actual plan data)
    const planDetails = {
      free: {
        name: "Free Tier",
        limit: 100,
        desc: "Basic access with limited messages",
      },
      starter: {
        name: "Starter",
        limit: 500,
        desc: "For small businesses getting started",
      },
      business: {
        name: "Business",
        limit: 2000,
        desc: "For growing businesses with moderate needs",
      },
      enterprise: {
        name: "Enterprise",
        limit: 10000,
        desc: "For high-volume business needs",
      },
      none: {
        name: "None",
        limit: 0,
        desc: "No active subscription",
      },
    };

    // Update this part in your dashboard HTML file's script section
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        goTo("signup-login.html");
        return;
      }

      const uid = user.uid;
      try {
        const docRef = db.collection("businesses").doc(user.uid);
        console.log("Document reference:", docRef); // Debug: Log document reference

        const doc = await docRef.get();

        if (!doc.exists) {
          console.error("No document found for this user!");
          document.getElementById("business-name").textContent =
            "Business (No profile)";
          return;
        }

        const data = doc.data();
        console.log("Document data:", data); // Debug: Log all document data

        // Debug: Check if name exists
        if (!data.name) {
          console.warn("No 'name' field found in document");
          console.warn("Available fields:", Object.keys(data));
        }

        // Update the welcome message - using nullish coalescing for better fallback
        const businessName = data.name;
        console.log("Setting business name to:", businessName); // Debug
        document.getElementById("business-name").textContent = businessName;

        // Update the rest of the dashboard data
        document.getElementById("business-email").textContent =
          data.email || "Not provided";

        // Update plan info
        const plan = data.plan || "none";
        const planData = planDetails[plan] || planDetails["none"];
        document.getElementById("current-plan").textContent = planData.name;
        document.getElementById("plan-desc").textContent = planData.desc;

        // Update message counts
        const messagesLeft = data.messagesLeft ?? 0;
        const messagesUsed =
          planData.limit - messagesLeft > 0
            ? planData.limit - messagesLeft
            : 0;

        document.getElementById("message-count").textContent = messagesLeft;
        document.getElementById("messages-used").textContent = messagesUsed;

        // Update usage bar
        if (planData.limit > 0) {
          const usagePercent = (messagesUsed / planData.limit) * 100;
          document.getElementById(
            "usage-bar"
          ).style.width = `${usagePercent}%`;
          document.getElementById("used-value").textContent = messagesUsed;
          document.getElementById("remaining-value").textContent =
            messagesLeft;
          document.getElementById("total-value").textContent = planData.limit;
        }

        // Show low message alert if needed
        if (messagesLeft / planData.limit < 0.2 && planData.limit > 0) {
          document.getElementById("low-message-alert").style.display = "flex";
        }

        // Set billing cycle date (you'll need to replace this with your actual billing cycle logic)
        const today = new Date();
        const nextMonth = new Date(
          today.getFullYear(),
          today.getMonth() + 1,
          1
        );
        document.getElementById("billing-cycle").textContent =
          nextMonth.getDate() +
          getOrdinalSuffix(nextMonth.getDate()) +
          " " +
          nextMonth.toLocaleString("default", { month: "long" });
      } catch (err) {
        console.error("Error loading dashboard:", err);
      }
    });

    // Helper function for date ordinal suffixes
    function getOrdinalSuffix(day) {
      if (day > 3 && day < 21) return "th";
      switch (day % 10) {
        case 1:
          return "st";
        case 2:
          return "nd";
        case 3:
          return "rd";
        default:
          return "th";
      }
    }

    // Event listeners
    document.getElementById("logout-btn").addEventListener("click", () => {
      auth.signOut().then(() => goTo("signup-login.html"));
    });

    document.getElementById("upgrade-btn").addEventListener("click", () => {
      goTo("upgrade.html");
    });

    document.getElementById("upgrade-btn-2").addEventListener("click", () => {
      goTo("upgrade.html");
    });

    document.getElementById("buy-msgs-btn").addEventListener("click", () => {
      goTo("buy-messages.html");
    });

    document
      .getElementById("buy-msgs-btn-2")
      .addEventListener("click", () => {
        goTo("buy-messages.html");
      });

    document.getElementById("settings-btn").addEventListener("click", () => {
      goTo("settings.html");
    });
  </script>
</body>

</html>